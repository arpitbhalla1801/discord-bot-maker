// This is your Prisma schema file for Neon Postgres
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Better-Auth Models (Required by better-auth)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  botProjects      BotProject[]
  plugins          Plugin[]
  commandTemplates CommandTemplate[]

  @@map("user")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("account")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  ipAddress    String?
  userAgent    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_token")
}

// ============================================
// Business Logic Models (Discord Bot Maker)
// ============================================

// A. Core Tables - The skeleton of the product

model BotProject {
  id          String   @id @default(cuid())
  name        String
  description String?
  discordBotId String? // Discord application/bot ID
  botToken    String?  // Encrypted Discord bot token
  icon        String?  // Bot icon URL
  status      String   @default("inactive") // active, inactive, error
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  commands       Command[]
  sessions       BotSession[]
  projectPlugins ProjectPlugin[]

  @@index([userId])
  @@index([status])
  @@map("bot_project")
}

model Command {
  id            String   @id @default(cuid())
  projectId     String
  name          String
  description   String
  type          String   @default("SLASH") // SLASH, MESSAGE, BUTTON, MODAL
  discordCmdId  String?  // Discord command ID for slash command registration
  isEnabled     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project       BotProject    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  commandGraphs CommandGraph[]

  @@unique([projectId, name])
  @@index([projectId])
  @@index([type])
  @@map("command")
}

model CommandGraph {
  id        String   @id @default(cuid())
  commandId String
  graphJson Json     // Scratch-like block logic (nodes + edges + settings)
  version   Int      @default(1)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  command Command @relation(fields: [commandId], references: [id], onDelete: Cascade)

  @@index([commandId])
  @@index([isActive])
  @@map("command_graph")
}

model BotSession {
  id          String    @id @default(cuid())
  projectId   String
  status      String    @default("RUNNING") // RUNNING, STOPPED, EXPIRED, FAILED
  runtimeNode String?   // Which worker/server handled this session
  lastError   String?   // Error message if status is FAILED
  startedAt   DateTime  @default(now())
  expiresAt   DateTime  // When the session should automatically stop
  stoppedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project BotProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([expiresAt])
  @@map("bot_session")
}

// B. Feature Tables - Plugins & Community Sharing

model Plugin {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  authorId    String
  version     String   @default("1.0.0")
  type        String   @default("BLOCKS") // BLOCKS, CODE
  manifest    Json     // What blocks, events, settings this plugin exposes
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author         User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  projectPlugins ProjectPlugin[]

  @@index([authorId])
  @@index([slug])
  @@index([isPublic])
  @@map("plugin")
}

model ProjectPlugin {
  id          String   @id @default(cuid())
  projectId   String
  pluginId    String
  config      Json?    // Per-project settings (channel IDs, messages, etc.)
  isEnabled   Boolean  @default(true)
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project BotProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  plugin  Plugin     @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([projectId, pluginId])
  @@index([projectId])
  @@index([pluginId])
  @@map("project_plugin")
}

model CommandTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  tags        String[] // Array of tags for categorization
  graphJson   Json     // Same structure as CommandGraph
  authorId    String
  isPublic    Boolean  @default(false)
  installs    Int      @default(0) // Track popularity
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([isPublic])
  @@index([tags])
  @@map("command_template")
}
